<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title><%= name %></title>
    <link rel="stylesheet" href="/static/css/GeistUi-style.css" />
    <link rel="stylesheet" href="/static/css/reset.css" />
    <style>
        .row a {color: #6c757d;}
        .arrow {position: fixed;bottom: 3rem;right: 3rem;z-index: 99;transition: all .3s;}
        .bottom {transform: rotate(180deg);}
    </style>
</head>
<body class="root">
<section class="loading">
    <h1><%= name %></h1>
</section>
<section id="app"></section>
<script type="text/template" id="tpl">
   <div class="zi-fieldset">
       <section class="d-flex" style="padding: 1.25rem">
           <div style="padding-right: 2rem">
               <img width="145" :src="book.image" />
           </div>
           <section class="flex-fill">
               <h1 class="m-0">
                   <span>{{ book.title }} </span>
                   <small>{{ book.author }}</small>
               </h1>
               <p>{{ book.description }}</p>
               <span v-if="book.newChapter">最新章节: {{ book.newChapter }}</span>
           </section>
       </section>
       <div class="zi-fieldset-footer">
           <section class="row">
               <div v-for="item in list" :key="item.href" class="col-12 col-md-4 mt-2">
                   <a href="/chapter.html">
                       {{ item.title }}
                   </a>
               </div>
           </section>
       </div>
       <div class="top" style="display: none">
           <svg width="24" viewBox="0 0 75 65" fill="#000" style="margin-top: -3px;"><path d="M37.59.25l36.95 64H.64l36.95-64z"></path></svg>
       </div>
   </div>
</script>

<script src="/static/script/g.js"></script>
<script src="/static/script/vue.min.js"></script>
<script src="/static/script/socket.io.min.js"></script>
<script>
    const url = new URLSearchParams(window.location.search);
    const loading = document.querySelector('.loading');

    // render page
    function render(book, list) {
        console.log(list);
        new Vue({
            el: '#app',
            template: document.getElementById('tpl').innerText,
            data: {
                book,
                list,
            }
        });
    }

    // request
    requestPost('/novel/info', {
        url: url.get('u'),
        origin: url.get('o')
    }).then(res => {
        if (res.code) {
            const { list, ...book } = res.data;
            render(book, list);
        }
    });

    // socket
    const socket = ws();
    socket.on('process', s => {
        appendMessage('p', s);
    });
    socket.on('processError', s => {
        appendMessage('e', s);
        console.log('processError', s);
    });
    socket.on('processSuccess', s => {
        appendMessage('s', s);
        requestAnimationFrame(() => {
            loading.remove();
        })
    });

    function appendMessage(type, s) {
        console.log(s);
        const t = {
            p: 'zi-note hint',
            e: 'zi-note error',
            s: 'zi-note hint',
        }
        const html = document.createElement('p');
        html.className = t[type];
        html.innerHTML = `<span class="zi-note-type">NOTE:</span> ${s}`;
        loading.appendChild(html);
    }
</script>
</body>
</html>
